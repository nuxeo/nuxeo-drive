name: Functional tests

on:
  pull_request:
    paths:
      - ".github/workflows/functional_tests.yml"
      - "nxdrive/**/*.py"
      - "tests/*.py"
      - "tests/functional/*.py"
      - "tools/deps/*.txt"
  push:
    branches: [master]
    paths:
      - "nxdrive/**/*.py"
      - "tests/*.py"
      - "tests/functional/*.py"

jobs:
  functional-tests-linux:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        lts_environment:  [ ["https://nuxeo-drive-preview.platform.dev.nuxeo.com/nuxeo",  "2021", "NXDRIVE_TEST_USERNAME",  "NXDRIVE_TEST_PASSWORD"],  ["https://drive-2023.beta.nuxeocloud.com/nuxeo",  "2023",  "NXDRIVE_2023_TEST_USERNAME", "NXDRIVE_2023_TEST_PASSWORD"] ]

    env:
      NXDRIVE_TEST_NUXEO_URL: ${{ matrix.lts_environment[0] }}
      NXDRIVE_TEST_USERNAME: ${{ secrets[matrix.lts_environment[2]] }}
      NXDRIVE_TEST_PASSWORD: ${{ secrets[matrix.lts_environment[3]] }}

    name: functional-tests-linux(LTS ${{ matrix.lts_environment[1] }})

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v3
        with:
          python-version: 3.9 # XXX_PYTHON
      - uses: actions/cache@v2.1.6
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
          restore-keys: ${{ runner.os }}-pip-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
      - uses: actions/cache@v2.1.6
        with:
          path: .tox
          key: ${{ runner.os }}-tox-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
          restore-keys: ${{ runner.os }}-tox-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
      - name: Install system dependencies
        run: |
          sudo apt install xclip
          Xvfb :99 -screen 0 1920x1080x24+32 &
      - name: Install tox
        run: python -m pip install -r tools/deps/requirements-tox.txt
      - name: Functional tests
        run: tox -e ft
        env:
          DISPLAY: ":99"
      - name: Upload coverage to Codecov
        if: ${{ success() }} || ${{ failure() }}
        uses: codecov/codecov-action@v1.5.2
        with:
          files: ./coverage.xml
          flags: functional
          env_vars: OS,PYTHON
      - name: Clean-up tests data
        run: tox -e clean

  functional-tests-macos:
      runs-on: "macos-latest"

      strategy:
        fail-fast: false
        matrix:
          lts_environment:  [ ["https://nuxeo-drive-preview.platform.dev.nuxeo.com/nuxeo",  "2021", "NXDRIVE_TEST_USERNAME",  "NXDRIVE_TEST_PASSWORD"],  ["https://drive-2023.beta.nuxeocloud.com/nuxeo",  "2023",  "NXDRIVE_2023_TEST_USERNAME", "NXDRIVE_2023_TEST_PASSWORD"] ]

      env:
        NXDRIVE_TEST_NUXEO_URL: ${{ matrix.lts_environment[0] }}
        NXDRIVE_TEST_USERNAME: ${{ secrets[matrix.lts_environment[2]] }}
        NXDRIVE_TEST_PASSWORD: ${{ secrets[matrix.lts_environment[3]] }}

      name: functional-tests-macos(LTS ${{ matrix.lts_environment[1] }})

      steps:
        - uses: actions/checkout@v2
        - uses: actions/setup-python@v3
          with:
            python-version: 3.9 # XXX_PYTHON
        - uses: actions/cache@v2.1.6
          with:
            path: ~/Library/Caches/pip
            key: ${{ runner.os }}-pip-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
            restore-keys: ${{ runner.os }}-pip-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
        - uses: actions/cache@v2.1.6
          with:
            path: .tox
            key: ${{ runner.os }}-tox-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
            restore-keys: ${{ runner.os }}-tox-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
        - name: Install tox
          run: python -m pip install -r tools/deps/requirements-tox.txt
        - name: Functional tests
          run: tox -e ft
        - name: Upload coverage to Codecov
          if: ${{ success() }} || ${{ failure() }}
          uses: codecov/codecov-action@v1.5.2
          with:
            files: ./coverage.xml
            flags: functional
            env_vars: OS,PYTHON
        - name: Clean-up tests data
          run: tox -e clean

  functional-tests-windows:
      runs-on: windows-latest

      strategy:
        fail-fast: false
        matrix:
          lts_environment:  [ ["https://nuxeo-drive-preview.platform.dev.nuxeo.com/nuxeo",  "2021", "NXDRIVE_TEST_USERNAME",  "NXDRIVE_TEST_PASSWORD"],  ["https://drive-2023.beta.nuxeocloud.com/nuxeo",  "2023",  "NXDRIVE_2023_TEST_USERNAME", "NXDRIVE_2023_TEST_PASSWORD"] ]

      env:
        NXDRIVE_TEST_NUXEO_URL: ${{ matrix.lts_environment[0] }}
        NXDRIVE_TEST_USERNAME: ${{ secrets[matrix.lts_environment[2]] }}
        NXDRIVE_TEST_PASSWORD: ${{ secrets[matrix.lts_environment[3]] }}

      name: functional-tests-windows(LTS ${{ matrix.lts_environment[1] }})

      steps:
        - uses: actions/checkout@v2
        - uses: actions/setup-python@v3
          with:
            python-version: 3.9 # XXX_PYTHON
        - uses: actions/cache@v2.1.6
          with:
            path: ~\AppData\Local\pip\Cache
            key: ${{ runner.os }}-pip-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
            restore-keys: ${{ runner.os }}-pip-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
        # Cannot be used for now: OSError: [WinError 193] %1 is not a valid Win32 application
        # - uses: actions/cache@v2.1.6
        #  with:
        #    path: .tox
        #    key: ${{ runner.os }}-tox-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
        #    restore-keys: ${{ runner.os }}-tox-${{ hashFiles('tools/deps/requirements.txt', 'tools/deps/requirements-test.txt', 'tools/deps/requirements-tox.txt') }}
        - name: Install tox
          run: python -m pip install -r tools/deps/requirements-tox.txt
        - name: Functional tests
          run: tox -e ft
        - name: Upload coverage to Codecov
          if: ${{ success() }} || ${{ failure() }}
          uses: codecov/codecov-action@v1.5.2
          with:
            files: ./coverage.xml
            flags: functional
            env_vars: OS,PYTHON
        - name: Clean-up tests data
          run: tox -e clean
